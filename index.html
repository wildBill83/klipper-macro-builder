<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klipper Macro Builder</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script>
    // Lucide React icons inline
    const Copy = ({ size = 24 }) => React.createElement('svg', {
        xmlns: "http://www.w3.org/2000/svg",
        width: size,
        height: size,
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: "currentColor",
        strokeWidth: 2,
        strokeLinecap: "round",
        strokeLinejoin: "round"
    }, [
        React.createElement('rect', { key: 1, width: "14", height: "14", x: "8", y: "8", rx: "2", ry: "2" }),
        React.createElement('path', { key: 2, d: "M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" })
    ]);

    const Check = ({ size = 24 }) => React.createElement('svg', {
        xmlns: "http://www.w3.org/2000/svg",
        width: size,
        height: size,
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: "currentColor",
        strokeWidth: 2,
        strokeLinecap: "round",
        strokeLinejoin: "round"
    }, React.createElement('path', null, "M20 6 9 17l-5-5"));

    const ChevronDown = ({ size = 24 }) => React.createElement('svg', {
        xmlns: "http://www.w3.org/2000/svg",
        width: size,
        height: size,
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: "currentColor",
        strokeWidth: 2,
        strokeLinecap: "round",
        strokeLinejoin: "round"
    }, React.createElement('path', null, "m6 9 6 6 6-6"));

    const ChevronUp = ({ size = 24 }) => React.createElement('svg', {
        xmlns: "http://www.w3.org/2000/svg",
        width: size,
        height: size,
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: "currentColor",
        strokeWidth: 2,
        strokeLinecap: "round",
        strokeLinejoin: "round"
    }, React.createElement('path', null, "m18 15-6-6-6 6"));
function KlipperMacroBuilder() {
  const [copied, setCopied] = useState(false);
  const [advancedOpen, setAdvancedOpen] = useState(false);
  const [sectionsOpen, setSectionsOpen] = useState({
    bedLeveling: true,
    nozzleCleaning: true,
    heating: true,
    purge: true,
    advanced: false,
  });

  const toggleSection = (section) => {
    setSectionsOpen(prev => ({ ...prev, [section]: !prev[section] }));
  };
  
  // Material-specific settings
  const [materialSettings, setMaterialSettings] = useState({
    PLA: { 
      heatSoak: 0, 
      chamberTemp: 0,
      pressureAdvance: 0.05,
      velocity: 300,
      accel: 3000,
      junctionDeviation: 0.005,
      zOffsetSmooth: 0.0,
      zOffsetTextured: 0.0,
    },
    PETG: { 
      heatSoak: 3, 
      chamberTemp: 0,
      pressureAdvance: 0.08,
      velocity: 250,
      accel: 2500,
      junctionDeviation: 0.005,
      zOffsetSmooth: 0.0,
      zOffsetTextured: 0.0,
    },
    ABS: { 
      heatSoak: 10, 
      chamberTemp: 40,
      pressureAdvance: 0.04,
      velocity: 300,
      accel: 3000,
      junctionDeviation: 0.005,
      zOffsetSmooth: 0.0,
      zOffsetTextured: 0.0,
    },
    ASA: { 
      heatSoak: 10, 
      chamberTemp: 40,
      pressureAdvance: 0.04,
      velocity: 300,
      accel: 3000,
      junctionDeviation: 0.005,
      zOffsetSmooth: 0.0,
      zOffsetTextured: 0.0,
    },
    TPU: { 
      heatSoak: 0, 
      chamberTemp: 0,
      pressureAdvance: 0.0,
      velocity: 60,
      accel: 1000,
      junctionDeviation: 0.005,
      zOffsetSmooth: 0.0,
      zOffsetTextured: 0.0,
    },
    NYLON: { 
      heatSoak: 15, 
      chamberTemp: 50,
      pressureAdvance: 0.03,
      velocity: 250,
      accel: 2500,
      junctionDeviation: 0.005,
      zOffsetSmooth: 0.0,
      zOffsetTextured: 0.0,
    },
    PC: { 
      heatSoak: 15, 
      chamberTemp: 60,
      pressureAdvance: 0.03,
      velocity: 250,
      accel: 2500,
      junctionDeviation: 0.005,
      zOffsetSmooth: 0.0,
      zOffsetTextured: 0.0,
    },
  });
  
  // Start Print Options
  const [startOptions, setStartOptions] = useState({
    bedMeshLoad: true,
    bedMeshName: 'default',
    bedMeshCalibrate: false,
    adaptiveMesh: false,
    qglBeforePrint: true,
    zTilt: false,
    homingOverride: true,
    homeYFirst: false,
    heatSoak: true,
    useMaterialHeatSoak: true,
    bedWarpCheck: false,
    bedWarpX: 150,
    bedWarpY: 150,
    bedWarpProbes: 3,
    bedWarpTolerance: 0.01,
    bedWarpInterval: 60,
    nozzlePreHeat: 150,
    nozzleBrushEnabled: false,
    nozzleBrushType: 'builtin',
    nozzleBrushMacro: 'CLEAN_NOZZLE',
    brushX: 50,
    brushY: 300,
    brushZ: 1,
    brushWidth: 50,
    brushOrientation: 'X',
    brushPasses: 3,
    cleanBeforeProbe: true,
    purgeLineType: 'adaptive',
    primeBlobSize: 0,
    fanSpeed: 0,
    useMaterialChamberTemp: true,
    hasChamberHeater: false,
    filamentType: true,
    velocityLimits: false,
    pressureAdvance: false,
    skewCorrection: false,
    skewProfileName: 'my_skew_profile',
    useClientVariables: true,
    useBedTypeZOffset: true,
    carbonFilterDuringPrint: false,
    carbonFilterPrintSpeed: 0.5,
  });

  // End Print Options
  const [endOptions, setEndOptions] = useState({
    parkPosition: 'back_center',
    parkZ: 'max',
    retract: 5,
    fanCooldown: true,
    cooldownTime: 60,
    disableSteppers: false,
    bedOff: false,
    partCooling: true,
    presentPart: true,
    beep: true,
    carbonFilter: false,
    carbonFilterDuration: 300,
    carbonFilterPostPrint: true,
    carbonFilterPostDuration: 600,
    resetAcceleration: true,
    defaultVelocity: 300,
    defaultAccel: 3000,
  });

  const updateStartOption = (key, value) => {
    // Handle mutual exclusivity for QGL and Z-Tilt
    if (key === 'qglBeforePrint' && value === true) {
      setStartOptions(prev => ({ ...prev, [key]: value, zTilt: false }));
    } else if (key === 'zTilt' && value === true) {
      setStartOptions(prev => ({ ...prev, [key]: value, qglBeforePrint: false }));
    } else {
      setStartOptions(prev => ({ ...prev, [key]: value }));
    }
  };

  const updateEndOption = (key, value) => {
    setEndOptions(prev => ({ ...prev, [key]: value }));
  };

  const updateMaterialSetting = (material, setting, value) => {
    setMaterialSettings(prev => ({
      ...prev,
      [material]: {
        ...prev[material],
        [setting]: parseFloat(value)
      }
    }));
  };

  const generateNozzleCleanCode = () => {
    if (!startOptions.nozzleBrushEnabled) return '';
    
    if (startOptions.nozzleBrushType === 'custom') {
      return `
    # Clean nozzle using custom macro
    M117 Cleaning nozzle...
    ${startOptions.nozzleBrushMacro}`;
    }
    
    // Built-in brush pattern
    if (startOptions.useClientVariables) {
      let code = `
    # Clean nozzle with brush
    M117 Cleaning nozzle...
    G90                                    # Absolute positioning
    G1 Z10 F3000                           # Lift Z for clearance
    
    # Move to brush and lower to brush height
    {% if brush_orientation == "Y" %}
        G1 X{brush_x} Y{brush_y} F6000     # Position over brush
        G1 Z{brush_z} F3000                # Lower to brush height`;
      
      for (let i = 0; i < startOptions.brushPasses; i++) {
        code += `
        G1 Y{brush_y + brush_width} F3000  # Wipe along Y axis
        G1 Y{brush_y} F3000                # Return along Y axis`;
      }
      
      code += `
    {% else %}
        G1 X{brush_x} Y{brush_y} F6000     # Position over brush
        G1 Z{brush_z} F3000                # Lower to brush height`;
      
      for (let i = 0; i < startOptions.brushPasses; i++) {
        code += `
        G1 X{brush_x + brush_width} F3000  # Wipe along X axis
        G1 X{brush_x} F3000                # Return along X axis`;
      }
      
      code += `
    {% endif %}
    G1 Z10 F3000                           # Lift Z away from brush`;
      
      return code;
    } else {
      let code = `
    # Clean nozzle with brush
    M117 Cleaning nozzle...
    G90                                    # Absolute positioning
    G1 Z10 F3000                           # Lift Z for clearance
    
    # Move to brush and lower to brush height`;
      
      if (startOptions.brushOrientation === 'Y') {
        code += `
    G1 X${startOptions.brushX} Y${startOptions.brushY} F6000  # Position over brush
    G1 Z${startOptions.brushZ} F3000       # Lower to brush height`;
        
        for (let i = 0; i < startOptions.brushPasses; i++) {
          code += `
    G1 Y${startOptions.brushY + startOptions.brushWidth} F3000  # Wipe along Y axis
    G1 Y${startOptions.brushY} F3000       # Return along Y axis`;
        }
      } else {
        code += `
    G1 X${startOptions.brushX} Y${startOptions.brushY} F6000  # Position over brush
    G1 Z${startOptions.brushZ} F3000       # Lower to brush height`;
        
        for (let i = 0; i < startOptions.brushPasses; i++) {
          code += `
    G1 X${startOptions.brushX + startOptions.brushWidth} F3000  # Wipe along X axis
    G1 X${startOptions.brushX} F3000       # Return along X axis`;
        }
      }
      
      code += `
    G1 Z10 F3000                           # Lift Z away from brush`;
      
      return code;
    }
  };

  const generateStartMacro = () => {
    let macro = `[gcode_macro START_PRINT]
gcode:
    # Get parameters from slicer
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}`;

    if (startOptions.filamentType) {
      macro += `
    {% set FILAMENT_TYPE = params.FILAMENT_TYPE|default("PLA")|string %}`;
    }

    if (startOptions.useBedTypeZOffset) {
      macro += `
    {% set BED_TYPE = params.BED_TYPE|default("SMOOTH")|string %}`;
    }

    if (startOptions.useMaterialChamberTemp) {
      macro += `
    {% set CHAMBER_TEMP = params.CHAMBER_TEMP|default(0)|float %}`;
    }

    // _CLIENT_VARIABLE override support
    if (startOptions.useClientVariables) {
      macro += `
    
    # Load variables from _CLIENT_VARIABLE if defined (overrides settings below)
    {% if printer["gcode_macro _CLIENT_VARIABLE"] is defined %}`;
      
      if (startOptions.bedWarpCheck) {
        macro += `
        {% set warp_x = printer["gcode_macro _CLIENT_VARIABLE"].bed_warp_x|default(${startOptions.bedWarpX})|float %}
        {% set warp_y = printer["gcode_macro _CLIENT_VARIABLE"].bed_warp_y|default(${startOptions.bedWarpY})|float %}`;
      }
      
      if (startOptions.nozzleBrushEnabled && startOptions.nozzleBrushType === 'builtin') {
        macro += `
        {% set brush_x = printer["gcode_macro _CLIENT_VARIABLE"].brush_x|default(${startOptions.brushX})|float %}
        {% set brush_y = printer["gcode_macro _CLIENT_VARIABLE"].brush_y|default(${startOptions.brushY})|float %}
        {% set brush_z = printer["gcode_macro _CLIENT_VARIABLE"].brush_z|default(${startOptions.brushZ})|float %}
        {% set brush_width = printer["gcode_macro _CLIENT_VARIABLE"].brush_width|default(${startOptions.brushWidth})|float %}
        {% set brush_orientation = printer["gcode_macro _CLIENT_VARIABLE"].brush_orientation|default("${startOptions.brushOrientation}")|string %}`;
      }
      
      if (startOptions.bedMeshLoad) {
        macro += `
        {% set mesh_profile = printer["gcode_macro _CLIENT_VARIABLE"].mesh_profile|default("${startOptions.bedMeshName}")|string %}`;
      }
      
      if (startOptions.skewCorrection) {
        macro += `
        {% set skew_profile = printer["gcode_macro _CLIENT_VARIABLE"].skew_profile|default("${startOptions.skewProfileName}")|string %}`;
      }
      
      macro += `
    {% else %}`;
      
      if (startOptions.bedWarpCheck) {
        macro += `
        {% set warp_x = ${startOptions.bedWarpX} %}
        {% set warp_y = ${startOptions.bedWarpY} %}`;
      }
      
      if (startOptions.nozzleBrushEnabled && startOptions.nozzleBrushType === 'builtin') {
        macro += `
        {% set brush_x = ${startOptions.brushX} %}
        {% set brush_y = ${startOptions.brushY} %}
        {% set brush_z = ${startOptions.brushZ} %}
        {% set brush_width = ${startOptions.brushWidth} %}
        {% set brush_orientation = "${startOptions.brushOrientation}" %}`;
      }
      
      if (startOptions.bedMeshLoad) {
        macro += `
        {% set mesh_profile = "${startOptions.bedMeshName}" %}`;
      }
      
      if (startOptions.skewCorrection) {
        macro += `
        {% set skew_profile = "${startOptions.skewProfileName}" %}`;
      }
      
      macro += `
    {% endif %}`;
    }

    // Material-specific heat soak times
    if (startOptions.heatSoak && startOptions.useMaterialHeatSoak) {
      macro += `
    
    # Material-specific heat soak times (minutes)`;
      Object.keys(materialSettings).forEach(material => {
        macro += `
    {% set SOAK_${material} = ${materialSettings[material].heatSoak} %}`;
      });
      macro += `
    
    # Select soak time based on filament type
    {% if FILAMENT_TYPE == "PLA" %}
        {% set SOAK_TIME = SOAK_PLA %}`;
      Object.keys(materialSettings).slice(1).forEach(material => {
        macro += `
    {% elif FILAMENT_TYPE == "${material}" %}
        {% set SOAK_TIME = SOAK_${material} %}`;
      });
      macro += `
    {% else %}
        {% set SOAK_TIME = 0 %}
    {% endif %}`;
    }

    // Material-specific chamber temps
    if (startOptions.useMaterialChamberTemp) {
      macro += `
    
    # Material-specific chamber temps (override if CHAMBER_TEMP=0)
    {% if CHAMBER_TEMP == 0 %}`;
      Object.keys(materialSettings).forEach((material, idx) => {
        const condition = idx === 0 ? 'if' : 'elif';
        macro += `
        {% ${condition} FILAMENT_TYPE == "${material}" %}
            {% set CHAMBER_TEMP = ${materialSettings[material].chamberTemp} %}`;
      });
      macro += `
        {% endif %}
    {% endif %}`;
    }

    macro += `
    
    # Start sequence
    M117 Starting print...
    G90                                    # Absolute positioning
    M83                                    # Relative extruder mode`;

    if (endOptions.beep) {
      macro += `
    M300 S1000 P100                        # Beep`;
    }

    if (startOptions.homingOverride) {
      if (startOptions.homeYFirst) {
        macro += `
    
    # Homing (Y before X)
    G28 Y                                  # Home Y axis first
    G28 X Z                                # Home X and Z`;
      } else {
        macro += `
    
    # Homing
    G28                                    # Home all axes`;
      }
    } else {
      macro += `
    
    # Homing (add your custom homing routine)
    G28`;
    }

    macro += `
    
    # Heat bed and wait`;
    
    if (startOptions.heatSoak) {
      macro += `
    M117 Heating bed to {BED_TEMP}Â°C...
    M190 S{BED_TEMP}                       # Set and wait for bed temp`;
      
      if (startOptions.useMaterialHeatSoak) {
        macro += `
    
    # Heat soak based on material
    {% if SOAK_TIME > 0 %}
        M117 Heat soaking for {SOAK_TIME} minutes...
        G4 P{SOAK_TIME * 60000}            # Wait for heat soak
    {% endif %}`;
      }
    } else {
      macro += `
    M117 Heating bed...
    M190 S{BED_TEMP}                       # Set and wait for bed temp`;
    }

    // Bed warp verification after heat soak, before QGL/Z-tilt
    if (startOptions.bedWarpCheck) {
      if (startOptions.useClientVariables) {
        macro += `
    
    # Bed thermal expansion verification
    M117 Checking bed stability...
    {% set probe_samples = [] %}
    {% for i in range(${startOptions.bedWarpProbes}) %}
        G1 X{warp_x} Y{warp_y} F6000       # Move to verification point
        PROBE                              # Probe the bed
        {% set z = printer.probe.last_z_result %}
        {% set dummy = probe_samples.append(z) %}
        {% if i < ${startOptions.bedWarpProbes - 1} %}
            M117 Waiting ${startOptions.bedWarpInterval}s for bed stability...
            G4 P${startOptions.bedWarpInterval * 1000}
        {% endif %}
    {% endfor %}
    
    # Check if bed has stabilized (variance within tolerance)
    {% set min_z = probe_samples|min %}
    {% set max_z = probe_samples|max %}
    {% set variance = max_z - min_z %}
    M117 Bed variance: {variance}mm
    {% if variance > ${startOptions.bedWarpTolerance} %}
        M117 WARNING: Bed not stable! Variance: {variance}mm
        # Optionally pause or continue - adjust as needed
        # PAUSE
    {% else %}
        M117 Bed stable: {variance}mm variance
    {% endif %}`;
      } else {
        macro += `
    
    # Bed thermal expansion verification
    M117 Checking bed stability...
    {% set probe_samples = [] %}
    {% for i in range(${startOptions.bedWarpProbes}) %}
        G1 X${startOptions.bedWarpX} Y${startOptions.bedWarpY} F6000  # Move to verification point
        PROBE                              # Probe the bed
        {% set z = printer.probe.last_z_result %}
        {% set dummy = probe_samples.append(z) %}
        {% if i < ${startOptions.bedWarpProbes - 1} %}
            M117 Waiting ${startOptions.bedWarpInterval}s for bed stability...
            G4 P${startOptions.bedWarpInterval * 1000}
        {% endif %}
    {% endfor %}
    
    # Check if bed has stabilized (variance within tolerance)
    {% set min_z = probe_samples|min %}
    {% set max_z = probe_samples|max %}
    {% set variance = max_z - min_z %}
    M117 Bed variance: {variance}mm
    {% if variance > ${startOptions.bedWarpTolerance} %}
        M117 WARNING: Bed not stable! Variance: {variance}mm
        # Optionally pause or continue - adjust as needed
        # PAUSE
    {% else %}
        M117 Bed stable: {variance}mm variance
    {% endif %}`;
      }
    }

    if (startOptions.qglBeforePrint) {
      macro += `
    
    # Quad Gantry Level
    M117 QGL...
    QUAD_GANTRY_LEVEL
    G28 Z                                  # Re-home Z after QGL`;
    }

    if (startOptions.zTilt) {
      macro += `
    
    # Z-Tilt Adjustment
    M117 Z-Tilt...
    Z_TILT_ADJUST
    G28 Z                                  # Re-home Z after tilt`;
    }

    if (startOptions.nozzlePreHeat > 0) {
      macro += `
    
    # Pre-heat nozzle for probing
    M117 Pre-heating nozzle...
    M109 S${startOptions.nozzlePreHeat}    # Set and wait for nozzle preheat`;
    }

    // Clean nozzle before probing to prevent ooze affecting Z offset
    if (startOptions.cleanBeforeProbe && startOptions.nozzleBrushEnabled) {
      macro += `
    ${generateNozzleCleanCode()}`;
    }

    if (startOptions.bedMeshCalibrate) {
      macro += `
    
    # Calibrate bed mesh
    M117 Calibrating bed mesh...`;
      
      if (startOptions.adaptiveMesh) {
        macro += `
    BED_MESH_CALIBRATE ADAPTIVE=1          # Adaptive mesh based on print area`;
      } else {
        macro += `
    BED_MESH_CALIBRATE                     # Full bed mesh`;
      }
    } else if (startOptions.bedMeshLoad) {
      if (startOptions.useClientVariables) {
        macro += `
    
    # Load bed mesh
    M117 Loading bed mesh...
    BED_MESH_PROFILE LOAD={mesh_profile}   # Load saved mesh`;
      } else {
        macro += `
    
    # Load bed mesh
    M117 Loading bed mesh...
    BED_MESH_PROFILE LOAD=${startOptions.bedMeshName}  # Load saved mesh`;
      }
    }

    macro += `
    
    # Heat nozzle to print temp
    M117 Heating nozzle to {EXTRUDER_TEMP}Â°C...
    M109 S{EXTRUDER_TEMP}                  # Set and wait for nozzle temp`;

    if (startOptions.useMaterialChamberTemp) {
      macro += `
    
    # Wait for chamber temp (if equipped and required)
    {% if CHAMBER_TEMP > 0 %}
        M117 Waiting for chamber {CHAMBER_TEMP}Â°C...`;
      
      if (startOptions.hasChamberHeater) {
        macro += `
        M191 S{CHAMBER_TEMP}               # Set and wait for chamber heater`;
      } else {
        macro += `
        TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={CHAMBER_TEMP}`;
      }
      
      macro += `
    {% endif %}`;
    }

    // Clean nozzle after full heating (before printing) - only if not already cleaned before probing
    if (startOptions.nozzleBrushEnabled && !startOptions.cleanBeforeProbe) {
      macro += `
    ${generateNozzleCleanCode()}`;
    }

    if (startOptions.skewCorrection) {
      if (startOptions.useClientVariables) {
        macro += `
    
    # Apply skew correction
    SKEW_PROFILE LOAD={skew_profile}`;
      } else {
        macro += `
    
    # Apply skew correction
    SKEW_PROFILE LOAD=${startOptions.skewProfileName}`;
      }
    }

    if (startOptions.pressureAdvance) {
      macro += `
    
    # Set pressure advance based on filament type`;
      Object.keys(materialSettings).forEach((material, idx) => {
        const condition = idx === 0 ? 'if' : 'elif';
        macro += `
    {% ${condition} FILAMENT_TYPE == "${material}" %}
        SET_PRESSURE_ADVANCE ADVANCE=${materialSettings[material].pressureAdvance}`;
      });
      macro += `
    {% endif %}`;
    }

    if (startOptions.velocityLimits) {
      macro += `
    
    # Set velocity limits based on filament type`;
      Object.keys(materialSettings).forEach((material, idx) => {
        const condition = idx === 0 ? 'if' : 'elif';
        const settings = materialSettings[material];
        macro += `
    {% ${condition} FILAMENT_TYPE == "${material}" %}
        SET_VELOCITY_LIMIT VELOCITY=${settings.velocity} ACCEL=${settings.accel} SQUARE_CORNER_VELOCITY=${settings.junctionDeviation}`;
      });
      macro += `
    {% endif %}`;
    }

    // Z offset based on material and bed type
    if (startOptions.useBedTypeZOffset) {
      macro += `
    
    # Set Z offset based on material and bed type`;
      Object.keys(materialSettings).forEach((material, idx) => {
        const condition = idx === 0 ? 'if' : 'elif';
        const settings = materialSettings[material];
        macro += `
    {% ${condition} FILAMENT_TYPE == "${material}" %}
        {% if BED_TYPE == "TEXTURED" %}
            SET_GCODE_OFFSET Z=${settings.zOffsetTextured}
        {% else %}
            SET_GCODE_OFFSET Z=${settings.zOffsetSmooth}
        {% endif %}`;
      });
      macro += `
    {% endif %}`;
    }

    // Carbon filter during print
    if (startOptions.carbonFilterDuringPrint) {
      macro += `
    
    # Start carbon filter for fume control during print
    SET_FAN_SPEED FAN=carbon_filter SPEED=${startOptions.carbonFilterPrintSpeed}`;
    }

    if (startOptions.fanSpeed > 0) {
      macro += `
    
    # Set part cooling fan
    M106 S${Math.round(startOptions.fanSpeed * 2.55)}  # Set fan to ${startOptions.fanSpeed}%`;
    }

    if (startOptions.purgeLineType !== 'none') {
      macro += `
    
    # Purge line`;
      
      if (startOptions.purgeLineType === 'adaptive') {
        macro += `
    M117 Adaptive purge...
    ADAPTIVE_PURGE                         # Adaptive purge near print`;
      } else if (startOptions.purgeLineType === 'line_front') {
        macro += `
    M117 Purge line...
    G1 Z2.0 F3000                          # Move Z up
    G1 X10 Y10 Z0.3 F5000                  # Move to start position
    G1 X10 Y200 Z0.3 F1500 E15             # Draw purge line
    G1 X12 Y200 Z0.3 F5000                 # Move over
    G1 X12 Y10 Z0.3 F1500 E30              # Draw second line
    G92 E0                                 # Reset extruder
    G1 Z2.0 F3000                          # Move Z up`;
      } else if (startOptions.purgeLineType === 'blob') {
        macro += `
    M117 Prime blob...
    G1 X10 Y10 Z0.3 F5000                  # Move to blob position
    G1 E10 F300                            # Extrude blob
    G92 E0                                 # Reset extruder
    G1 Z2.0 F3000                          # Move Z up`;
      }
    }

    if (startOptions.primeBlobSize > 0) {
      macro += `
    
    # Additional prime blob
    G1 E${startOptions.primeBlobSize} F300 # Extra prime
    G92 E0                                 # Reset extruder`;
    }

    macro += `
    
    # Ready to print
    M117 Printing...
    G92 E0                                 # Reset extruder position`;

    return macro;
  };

  const generateEndMacro = () => {
    let macro = `[gcode_macro END_PRINT]
gcode:
    # Get print stats
    {% set RAN = printer.print_stats.print_duration %}
    
    M117 Print complete!`;

    if (endOptions.beep) {
      macro += `
    M300 S1000 P200                        # Beep twice
    G4 P100
    M300 S1000 P200`;
    }

    // Stop carbon filter if it was running during print
    if (startOptions.carbonFilterDuringPrint) {
      macro += `
    
    # Stop carbon filter
    SET_FAN_SPEED FAN=carbon_filter SPEED=0`;
    }

    macro += `
    
    # Retract filament`;
    if (endOptions.retract > 0) {
      macro += `
    G91                                    # Relative positioning
    G1 E-${endOptions.retract} F2700       # Retract ${endOptions.retract}mm
    G90                                    # Absolute positioning`;
    }

    if (endOptions.partCooling) {
      macro += `
    
    # Part cooling
    M106 S255                              # Fan to 100%`;
    }

    macro += `
    
    # Move toolhead away`;
    
    let parkX = '10';
    let parkY = '10';
    
    if (endOptions.parkPosition === 'back_center') {
      parkX = 'printer.toolhead.axis_maximum.x / 2';
      parkY = 'printer.toolhead.axis_maximum.y - 10';
    } else if (endOptions.parkPosition === 'back_left') {
      parkX = '10';
      parkY = 'printer.toolhead.axis_maximum.y - 10';
    } else if (endOptions.parkPosition === 'back_right') {
      parkX = 'printer.toolhead.axis_maximum.x - 10';
      parkY = 'printer.toolhead.axis_maximum.y - 10';
    } else if (endOptions.parkPosition === 'front_center') {
      parkX = 'printer.toolhead.axis_maximum.x / 2';
      parkY = '10';
    }

    let parkZ = '';
    if (endOptions.parkZ === 'max') {
      parkZ = `
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set cur_z = printer.toolhead.position.z|float %}
    {% if cur_z < (max_z - 5) %}
        G1 Z{max_z - 5} F600               # Move to near max Z
    {% endif %}`;
    } else if (endOptions.parkZ === 'relative') {
      parkZ = `
    G91                                    # Relative positioning
    G1 Z10 F600                            # Move Z up 10mm
    G90                                    # Absolute positioning`;
    }

    macro += `${parkZ}
    G1 X{${parkX}} Y{${parkY}} F6000       # Park toolhead`;

    if (endOptions.presentPart) {
      macro += `
    
    # Present part
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    G1 Z{max_z * 0.8} F600                 # Lower bed for part removal`;
    }

    if (endOptions.fanCooldown && endOptions.cooldownTime > 0) {
      macro += `
    
    # Cool down with fan
    M117 Cooling for ${endOptions.cooldownTime}s...
    G4 P${endOptions.cooldownTime * 1000}  # Wait while cooling`;
    }

    macro += `
    
    # Turn off heaters`;
    
    if (!endOptions.bedOff) {
      macro += `
    M104 S0                                # Turn off hotend`;
    } else {
      macro += `
    M104 S0                                # Turn off hotend
    M140 S0                                # Turn off bed`;
    }

    if (endOptions.partCooling) {
      macro += `
    M107                                   # Turn off part cooling fan`;
    }

    // Carbon filter during cooldown phase
    if (endOptions.carbonFilter && endOptions.carbonFilterDuration > 0) {
      macro += `
    
    # Run carbon filter during cooldown
    M117 Filtering air during cooldown...
    SET_FAN_SPEED FAN=carbon_filter SPEED=1.0
    G4 P${endOptions.carbonFilterDuration * 1000}  # Run for ${endOptions.carbonFilterDuration}s
    SET_FAN_SPEED FAN=carbon_filter SPEED=0`;
    }

    // Reset acceleration to defaults for sensorless homing
    if (endOptions.resetAcceleration) {
      macro += `
    
    # Reset acceleration to defaults (prevents false sensorless homing)
    SET_VELOCITY_LIMIT VELOCITY=${endOptions.defaultVelocity} ACCEL=${endOptions.defaultAccel} ACCEL_TO_DECEL=${Math.round(endOptions.defaultAccel / 2)}`;
    }

    if (endOptions.disableSteppers) {
      macro += `
    
    # Disable steppers
    M84                                    # Disable all steppers`;
    }

    macro += `
    
    # Print complete message
    M117 Done! Time: {RAN//3600}h {(RAN%3600)//60}m {RAN%60}s`;

    // Post-print carbon filter runs AFTER everything else is done
    if (endOptions.carbonFilterPostPrint && endOptions.carbonFilterPostDuration > 0) {
      macro += `
    
    # Post-print air filtration (extended cleaning)
    M117 Post-print air filtration...
    SET_FAN_SPEED FAN=carbon_filter SPEED=1.0
    G4 P${endOptions.carbonFilterPostDuration * 1000}  # Filter for ${endOptions.carbonFilterPostDuration}s
    SET_FAN_SPEED FAN=carbon_filter SPEED=0
    M117 Ready`;
    }

    return macro;
  };

  const fullMacro = `${generateStartMacro()}

${generateEndMacro()}`;

  const copyToClipboard = () => {
    navigator.clipboard.writeText(fullMacro);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-gray-900 p-6">
      <div className="max-w-7xl mx-auto">
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-white mb-2">Klipper Macro Builder</h1>
          <p className="text-blue-200">Visually configure your START_PRINT and END_PRINT macros</p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          {/* START_PRINT Configuration */}
          <div className="bg-white/10 backdrop-blur-lg rounded-lg p-6 border border-white/20">
            <h2 className="text-2xl font-bold text-white mb-4">ðŸš€ START_PRINT Options</h2>
            
            <div className="space-y-4">
              <div className="bg-white/5 p-4 rounded">
                <button
                  onClick={() => toggleSection('bedLeveling')}
                  className="w-full flex items-center justify-between text-white mb-3"
                >
                  <h3 className="text-lg font-semibold text-blue-300">Bed Leveling</h3>
                  {sectionsOpen.bedLeveling ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                </button>
                
                {sectionsOpen.bedLeveling && (
                  <>
                    <label className="flex items-center text-white mb-2">
                      <input
                        type="checkbox"
                        checked={startOptions.homeYFirst}
                        onChange={(e) => updateStartOption('homeYFirst', e.target.checked)}
                        className="mr-2 w-4 h-4"
                      />
                      Home Y Before X
                    </label>
                    <p className="text-xs text-blue-200 mb-3 ml-6">For bed-slinger printers to prevent crashes</p>
                
                <label className="flex items-center text-white mb-2">
                  <input
                    type="checkbox"
                    checked={startOptions.bedWarpCheck}
                    onChange={(e) => updateStartOption('bedWarpCheck', e.target.checked)}
                    className="mr-2 w-4 h-4"
                  />
                  Bed Thermal Expansion Check
                </label>
                <p className="text-xs text-blue-200 mb-2 ml-6">Verify bed stability after heat soak (Sovol SV08, etc.)</p>
                
                {startOptions.bedWarpCheck && (
                  <div className="ml-6 mb-3 space-y-2">
                    <div className="grid grid-cols-2 gap-2">
                      <div>
                        <label className="block text-white text-sm mb-1">Probe X</label>
                        <input
                          type="number"
                          value={startOptions.bedWarpX}
                          onChange={(e) => updateStartOption('bedWarpX', parseInt(e.target.value))}
                          className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                        />
                      </div>
                      <div>
                        <label className="block text-white text-sm mb-1">Probe Y</label>
                        <input
                          type="number"
                          value={startOptions.bedWarpY}
                          onChange={(e) => updateStartOption('bedWarpY', parseInt(e.target.value))}
                          className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                        />
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-2">
                      <div>
                        <label className="block text-white text-sm mb-1">Probe Count</label>
                        <input
                          type="number"
                          value={startOptions.bedWarpProbes}
                          onChange={(e) => updateStartOption('bedWarpProbes', parseInt(e.target.value))}
                          className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                          min="2"
                          max="10"
                        />
                      </div>
                      <div>
                        <label className="block text-white text-sm mb-1">Interval (sec)</label>
                        <input
                          type="number"
                          value={startOptions.bedWarpInterval}
                          onChange={(e) => updateStartOption('bedWarpInterval', parseInt(e.target.value))}
                          className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                          min="10"
                          max="300"
                        />
                      </div>
                    </div>
                    <div>
                      <label className="block text-white text-sm mb-1">Tolerance (mm)</label>
                      <input
                        type="number"
                        value={startOptions.bedWarpTolerance}
                        onChange={(e) => updateStartOption('bedWarpTolerance', parseFloat(e.target.value))}
                        className="w-24 px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                        min="0.001"
                        max="0.1"
                        step="0.001"
                      />
                      <p className="text-xs text-blue-200 mt-1">Max variance between probes</p>
                    </div>
                  </div>
                )}
                
                <label className="flex items-center text-white mb-2">
                  <input
                    type="checkbox"
                    checked={startOptions.bedMeshLoad}
                    onChange={(e) => updateStartOption('bedMeshLoad', e.target.checked)}
                    disabled={startOptions.bedMeshCalibrate}
                    className="mr-2 w-4 h-4"
                  />
                  Load Saved Bed Mesh
                </label>
                
                {startOptions.bedMeshLoad && !startOptions.bedMeshCalibrate && (
                  <div className="ml-6 mb-3">
                    <label className="block text-white mb-1">Mesh Profile Name</label>
                    <input
                      type="text"
                      value={startOptions.bedMeshName}
                      onChange={(e) => updateStartOption('bedMeshName', e.target.value)}
                      className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                      placeholder="default"
                    />
                  </div>
                )}
                
                <label className="flex items-center text-white mb-2">
                  <input
                    type="checkbox"
                    checked={startOptions.bedMeshCalibrate}
                    onChange={(e) => updateStartOption('bedMeshCalibrate', e.target.checked)}
                    className="mr-2 w-4 h-4"
                  />
                  Calibrate Bed Mesh
                </label>
                
                {startOptions.bedMeshCalibrate && (
                  <label className="flex items-center text-white ml-6 mb-2">
                    <input
                      type="checkbox"
                      checked={startOptions.adaptiveMesh}
                      onChange={(e) => updateStartOption('adaptiveMesh', e.target.checked)}
                      className="mr-2 w-4 h-4"
                    />
                    Adaptive Mesh (print area only)
                  </label>
                )}
                
                <label className="flex items-center text-white mb-2">
                  <input
                    type="checkbox"
                    checked={startOptions.qglBeforePrint}
                    onChange={(e) => updateStartOption('qglBeforePrint', e.target.checked)}
                    className="mr-2 w-4 h-4"
                  />
                  Quad Gantry Level (QGL)
                </label>
                
                    <label className="flex items-center text-white">
                      <input
                        type="checkbox"
                        checked={startOptions.zTilt}
                        onChange={(e) => updateStartOption('zTilt', e.target.checked)}
                        className="mr-2 w-4 h-4"
                      />
                      Z-Tilt Adjustment
                    </label>
                    <p className="text-xs text-blue-200 mt-1 ml-6">* QGL and Z-Tilt are mutually exclusive</p>
                  </>
                )}
              </div>

              <div className="bg-white/5 p-4 rounded">
                <button
                  onClick={() => toggleSection('nozzleCleaning')}
                  className="w-full flex items-center justify-between text-white mb-3"
                >
                  <h3 className="text-lg font-semibold text-blue-300">Nozzle Cleaning</h3>
                  {sectionsOpen.nozzleCleaning ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                </button>
                
                {sectionsOpen.nozzleCleaning && (
                  <>
                    <label className="flex items-center text-white mb-2">
                  <input
                    type="checkbox"
                    checked={startOptions.nozzleBrushEnabled}
                    onChange={(e) => updateStartOption('nozzleBrushEnabled', e.target.checked)}
                    className="mr-2 w-4 h-4"
                  />
                  Enable Nozzle Brush/Cleaning
                </label>
                
                {startOptions.nozzleBrushEnabled && (
                  <>
                    <label className="flex items-center text-white mb-3 ml-6">
                      <input
                        type="checkbox"
                        checked={startOptions.cleanBeforeProbe}
                        onChange={(e) => updateStartOption('cleanBeforeProbe', e.target.checked)}
                        className="mr-2 w-4 h-4"
                      />
                      Clean Before Probing
                    </label>
                    <p className="text-xs text-blue-200 mb-3 ml-12">
                      Removes ooze before mesh calibration for accurate Z offset
                      {!startOptions.cleanBeforeProbe && ' (will clean after full heating instead)'}
                    </p>
                  </>
                )}
                
                {startOptions.nozzleBrushEnabled && (
                  <div className="ml-6 space-y-3">
                    <div>
                      <label className="block text-white mb-1">Cleaning Method</label>
                      <select
                        value={startOptions.nozzleBrushType}
                        onChange={(e) => updateStartOption('nozzleBrushType', e.target.value)}
                        className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                      >
                        <option value="builtin">Built-in Brush Pattern</option>
                        <option value="custom">Custom Macro</option>
                      </select>
                    </div>
                    
                    {startOptions.nozzleBrushType === 'custom' ? (
                      <div>
                        <label className="block text-white mb-1">Macro Name</label>
                        <input
                          type="text"
                          value={startOptions.nozzleBrushMacro}
                          onChange={(e) => updateStartOption('nozzleBrushMacro', e.target.value)}
                          className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                          placeholder="CLEAN_NOZZLE"
                        />
                        <p className="text-xs text-blue-200 mt-1">Enter your existing macro name</p>
                      </div>
                    ) : (
                      <div className="space-y-2">
                        <div>
                          <label className="block text-white text-sm mb-1">Brush Orientation</label>
                          <select
                            value={startOptions.brushOrientation}
                            onChange={(e) => updateStartOption('brushOrientation', e.target.value)}
                            className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                          >
                            <option value="X">Along X-axis (left-right)</option>
                            <option value="Y">Along Y-axis (front-back)</option>
                          </select>
                        </div>
                        <div className="grid grid-cols-3 gap-2">
                          <div>
                            <label className="block text-white text-sm mb-1">Brush X</label>
                            <input
                              type="number"
                              value={startOptions.brushX}
                              onChange={(e) => updateStartOption('brushX', parseInt(e.target.value))}
                              className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                            />
                          </div>
                          <div>
                            <label className="block text-white text-sm mb-1">Brush Y</label>
                            <input
                              type="number"
                              value={startOptions.brushY}
                              onChange={(e) => updateStartOption('brushY', parseInt(e.target.value))}
                              className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                            />
                          </div>
                          <div>
                            <label className="block text-white text-sm mb-1">Brush Z</label>
                            <input
                              type="number"
                              value={startOptions.brushZ}
                              onChange={(e) => updateStartOption('brushZ', parseFloat(e.target.value))}
                              className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                              step="0.1"
                            />
                          </div>
                        </div>
                        <p className="text-xs text-blue-200">Z height: nozzle height when in contact with brush</p>
                        <div className="grid grid-cols-2 gap-2">
                          <div>
                            <label className="block text-white text-sm mb-1">Brush Width</label>
                            <input
                              type="number"
                              value={startOptions.brushWidth}
                              onChange={(e) => updateStartOption('brushWidth', parseInt(e.target.value))}
                              className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                            />
                            <p className="text-xs text-blue-200 mt-1">
                              {startOptions.brushOrientation === 'X' ? 'Width along X-axis' : 'Width along Y-axis'}
                            </p>
                          </div>
                          <div>
                            <label className="block text-white text-sm mb-1">Wipe Passes</label>
                            <input
                              type="number"
                              value={startOptions.brushPasses}
                              onChange={(e) => updateStartOption('brushPasses', parseInt(e.target.value))}
                              className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                              min="1"
                              max="10"
                            />
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}
                  </>
                )}
              </div>

              <div className="bg-white/5 p-4 rounded">
                <button
                  onClick={() => toggleSection('heating')}
                  className="w-full flex items-center justify-between text-white mb-3"
                >
                  <h3 className="text-lg font-semibold text-blue-300">Heating</h3>
                  {sectionsOpen.heating ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                </button>
                
                {sectionsOpen.heating && (
                  <>
                    <label className="flex items-center text-white mb-2">
                      <input
                        type="checkbox"
                        checked={startOptions.heatSoak}
                        onChange={(e) => updateStartOption('heatSoak', e.target.checked)}
                        className="mr-2 w-4 h-4"
                      />
                      Heat Soak (material-based)
                    </label>
                    
                    <label className="flex items-center text-white mb-2">
                      <input
                        type="checkbox"
                        checked={startOptions.useMaterialChamberTemp}
                        onChange={(e) => updateStartOption('useMaterialChamberTemp', e.target.checked)}
                        className="mr-2 w-4 h-4"
                      />
                      Enable Chamber Temperature Control
                    </label>
                    <p className="text-xs text-blue-200 mb-3 ml-6">
                      {startOptions.useMaterialChamberTemp 
                        ? "Uses OrcaSlicer CHAMBER_TEMP parameter if provided (>0), otherwise falls back to material-specific defaults configured below. Waits for chamber to reach target temp before printing."
                        : "Chamber temperature control disabled"}
                    </p>
                    
                    {startOptions.useMaterialChamberTemp && (
                      <label className="flex items-center text-white mb-2 ml-6">
                        <input
                          type="checkbox"
                          checked={startOptions.hasChamberHeater}
                          onChange={(e) => updateStartOption('hasChamberHeater', e.target.checked)}
                          className="mr-2 w-4 h-4"
                        />
                        Has Active Chamber Heater
                      </label>
                    )}
                    {startOptions.useMaterialChamberTemp && (
                      <p className="text-xs text-blue-200 mb-3 ml-12">
                        {startOptions.hasChamberHeater
                          ? "Will use M191 to heat chamber actively"
                          : "Will wait passively for chamber sensor to reach temp"}
                      </p>
                    )}
                    
                    <div className="mb-3">
                      <label className="block text-white mb-1">Nozzle Pre-Heat Temp (Â°C)</label>
                      <input
                        type="number"
                        value={startOptions.nozzlePreHeat}
                        onChange={(e) => updateStartOption('nozzlePreHeat', parseInt(e.target.value))}
                        className="w-24 px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                        min="0"
                        max="200"
                      />
                      <p className="text-xs text-blue-200 mt-1">For probing without ooze (0 to disable)</p>
                    </div>
                  </>
                )}
              </div>

              <div className="bg-white/5 p-4 rounded">
                <button
                  onClick={() => toggleSection('purge')}
                  className="w-full flex items-center justify-between text-white mb-3"
                >
                  <h3 className="text-lg font-semibold text-blue-300">Purge & Prime</h3>
                  {sectionsOpen.purge ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                </button>
                
                {sectionsOpen.purge && (
                  <>
                
                    <div className="mb-3">
                      <label className="block text-white mb-1">Purge Line Type</label>
                      <select
                        value={startOptions.purgeLineType}
                        onChange={(e) => updateStartOption('purgeLineType', e.target.value)}
                        className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                      >
                        <option value="none">None</option>
                        <option value="adaptive">Adaptive (near print)</option>
                        <option value="line_front">Front Line</option>
                        <option value="blob">Prime Blob</option>
                      </select>
                    </div>
                    
                    <div>
                      <label className="block text-white mb-1">Extra Prime (mm)</label>
                      <input
                        type="number"
                        value={startOptions.primeBlobSize}
                        onChange={(e) => updateStartOption('primeBlobSize', parseInt(e.target.value))}
                        className="w-24 px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                        min="0"
                        max="20"
                      />
                    </div>
                  </>
                )}
              </div>

              <div className="bg-white/5 p-4 rounded">
                <button
                  onClick={() => toggleSection('advanced')}
                  className="w-full flex items-center justify-between text-white mb-3"
                >
                  <h3 className="text-lg font-semibold text-blue-300">Advanced Settings</h3>
                  {sectionsOpen.advanced ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                </button>
                
                {sectionsOpen.advanced && (
                  <>
                    <label className="flex items-center text-white mb-2">
                      <input
                        type="checkbox"
                        checked={startOptions.useClientVariables}
                        onChange={(e) => updateStartOption('useClientVariables', e.target.checked)}
                        className="mr-2 w-4 h-4"
                      />
                      Support _CLIENT_VARIABLE Overrides
                    </label>
                    <p className="text-xs text-blue-200 mb-3 ml-6">
                      Allows centralized config without editing macro
                    </p>
                
                <label className="flex items-center text-white mb-2">
                  <input
                    type="checkbox"
                    checked={startOptions.useBedTypeZOffset}
                    onChange={(e) => updateStartOption('useBedTypeZOffset', e.target.checked)}
                    className="mr-2 w-4 h-4"
                  />
                  Bed Type Z Offset (Smooth/Textured)
                </label>
                <p className="text-xs text-blue-200 mb-3 ml-6">
                  Auto-adjust Z offset based on BED_TYPE parameter
                </p>
                
                <label className="flex items-center text-white mb-2">
                  <input
                    type="checkbox"
                    checked={startOptions.filamentType}
                    onChange={(e) => updateStartOption('filamentType', e.target.checked)}
                    className="mr-2 w-4 h-4"
                  />
                  Filament Type Parameter
                </label>
                
                    <label className="flex items-center text-white mb-2">
                      <input
                        type="checkbox"
                        checked={startOptions.pressureAdvance}
                        onChange={(e) => updateStartOption('pressureAdvance', e.target.checked)}
                        className="mr-2 w-4 h-4"
                      />
                      Auto Pressure Advance (by filament)
                    </label>
                    
                    <label className="flex items-center text-white mb-2">
                      <input
                        type="checkbox"
                        checked={startOptions.velocityLimits}
                        onChange={(e) => updateStartOption('velocityLimits', e.target.checked)}
                        className="mr-2 w-4 h-4"
                      />
                      Auto Velocity Limits (by filament)
                    </label>
                    
                    {(startOptions.pressureAdvance || startOptions.velocityLimits) && (
                      <div className="ml-6 mb-3 p-2 bg-yellow-900/30 rounded border border-yellow-500/30">
                        <p className="text-xs text-yellow-200">
                          âš ï¸ <strong>Note:</strong> Most slicers (OrcaSlicer, PrusaSlicer, SuperSlicer) already handle pressure advance and velocity/acceleration limits per filament. 
                          Enabling these here will override slicer settings and may cause conflicts. Only enable if you prefer macro-based control over slicer control.
                        </p>
                      </div>
                    )}
                
                    <label className="flex items-center text-white mb-2">
                      <input
                        type="checkbox"
                        checked={startOptions.skewCorrection}
                        onChange={(e) => updateStartOption('skewCorrection', e.target.checked)}
                        className="mr-2 w-4 h-4"
                      />
                      Skew Correction
                    </label>
                    
                    {startOptions.skewCorrection && (
                      <div className="ml-6 mb-3">
                        <label className="block text-white mb-1">Skew Profile Name</label>
                        <input
                          type="text"
                          value={startOptions.skewProfileName}
                          onChange={(e) => updateStartOption('skewProfileName', e.target.value)}
                          className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                          placeholder="my_skew_profile"
                        />
                      </div>
                    )}
                    
                    <div>
                      <label className="block text-white mb-1">Initial Fan Speed (%)</label>
                      <input
                        type="number"
                        value={startOptions.fanSpeed}
                        onChange={(e) => updateStartOption('fanSpeed', parseInt(e.target.value))}
                        className="w-24 px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                        min="0"
                        max="100"
                      />
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>

          {/* END_PRINT Configuration */}
          <div className="bg-white/10 backdrop-blur-lg rounded-lg p-6 border border-white/20">
            <h2 className="text-2xl font-bold text-white mb-4">ðŸ END_PRINT Options</h2>
            
            <div className="space-y-4">
              <div className="bg-white/5 p-4 rounded">
                <h3 className="text-lg font-semibold text-blue-300 mb-3">Toolhead Parking</h3>
                
                <div className="mb-3">
                  <label className="block text-white mb-1">Park Position</label>
                  <select
                    value={endOptions.parkPosition}
                    onChange={(e) => updateEndOption('parkPosition', e.target.value)}
                    className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                  >
                    <option value="back_center">Back Center</option>
                    <option value="back_left">Back Left</option>
                    <option value="back_right">Back Right</option>
                    <option value="front_center">Front Center</option>
                  </select>
                </div>
                
                <div className="mb-3">
                  <label className="block text-white mb-1">Z Position</label>
                  <select
                    value={endOptions.parkZ}
                    onChange={(e) => updateEndOption('parkZ', e.target.value)}
                    className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                  >
                    <option value="max">Near Max Z</option>
                    <option value="relative">+10mm Relative</option>
                  </select>
                </div>
                
                <label className="flex items-center text-white">
                  <input
                    type="checkbox"
                    checked={endOptions.presentPart}
                    onChange={(e) => updateEndOption('presentPart', e.target.checked)}
                    className="mr-2 w-4 h-4"
                  />
                  Present Part (lower bed)
                </label>
              </div>

              <div className="bg-white/5 p-4 rounded">
                <h3 className="text-lg font-semibold text-blue-300 mb-3">Retraction</h3>
                
                <div>
                  <label className="block text-white mb-1">Retract Distance (mm)</label>
                  <input
                    type="number"
                    value={endOptions.retract}
                    onChange={(e) => updateEndOption('retract', parseFloat(e.target.value))}
                    className="w-24 px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                    min="0"
                    max="20"
                    step="0.5"
                  />
                </div>
              </div>

              <div className="bg-white/5 p-4 rounded">
                <h3 className="text-lg font-semibold text-blue-300 mb-3">Cooling & Filtration</h3>
                
                <label className="flex items-center text-white mb-2">
                  <input
                    type="checkbox"
                    checked={endOptions.partCooling}
                    onChange={(e) => updateEndOption('partCooling', e.target.checked)}
                    className="mr-2 w-4 h-4"
                  />
                  Part Cooling Fan
                </label>
                
                <label className="flex items-center text-white mb-2">
                  <input
                    type="checkbox"
                    checked={endOptions.fanCooldown}
                    onChange={(e) => updateEndOption('fanCooldown', e.target.checked)}
                    className="mr-2 w-4 h-4"
                  />
                  Fan Cooldown Period
                </label>
                
                {endOptions.fanCooldown && (
                  <div className="ml-6 mb-3">
                    <label className="block text-white mb-1">Cooldown Time (seconds)</label>
                    <input
                      type="number"
                      value={endOptions.cooldownTime}
                      onChange={(e) => updateEndOption('cooldownTime', parseInt(e.target.value))}
                      className="w-24 px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                      min="0"
                      max="300"
                    />
                  </div>
                )}
                
                <div className="mt-4 mb-2">
                  <h4 className="text-md font-semibold text-blue-200 mb-2">Carbon Filter Options</h4>
                  <p className="text-xs text-blue-200 mb-3">
                    Configure when to run the carbon filter for fume removal
                  </p>
                </div>
                
                <label className="flex items-center text-white mb-2">
                  <input
                    type="checkbox"
                    checked={startOptions.carbonFilterDuringPrint}
                    onChange={(e) => updateStartOption('carbonFilterDuringPrint', e.target.checked)}
                    className="mr-2 w-4 h-4"
                  />
                  During Print (active filtration)
                </label>
                <p className="text-xs text-blue-200 ml-6 mb-2">
                  Runs throughout print for ABS/ASA fume control
                </p>
                
                {startOptions.carbonFilterDuringPrint && (
                  <div className="ml-6 mb-3">
                    <label className="block text-white mb-1">Filter Speed (0.0-1.0)</label>
                    <input
                      type="number"
                      value={startOptions.carbonFilterPrintSpeed}
                      onChange={(e) => updateStartOption('carbonFilterPrintSpeed', parseFloat(e.target.value))}
                      className="w-24 px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                      min="0.0"
                      max="1.0"
                      step="0.1"
                    />
                  </div>
                )}
                
                <label className="flex items-center text-white mb-2">
                  <input
                    type="checkbox"
                    checked={endOptions.carbonFilter}
                    onChange={(e) => updateEndOption('carbonFilter', e.target.checked)}
                    className="mr-2 w-4 h-4"
                  />
                  During Cooldown (immediate cleanup)
                </label>
                <p className="text-xs text-blue-200 ml-6 mb-2">
                  Runs while part cools, before steppers disable
                </p>
                
                {endOptions.carbonFilter && (
                  <div className="ml-6 mb-3">
                    <label className="block text-white mb-1">Filter Duration (seconds)</label>
                    <input
                      type="number"
                      value={endOptions.carbonFilterDuration}
                      onChange={(e) => updateEndOption('carbonFilterDuration', parseInt(e.target.value))}
                      className="w-24 px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                      min="0"
                      max="600"
                    />
                  </div>
                )}
                
                <label className="flex items-center text-white mb-2">
                  <input
                    type="checkbox"
                    checked={endOptions.carbonFilterPostPrint}
                    onChange={(e) => updateEndOption('carbonFilterPostPrint', e.target.checked)}
                    className="mr-2 w-4 h-4"
                  />
                  Post-Print (extended cleaning)
                </label>
                <p className="text-xs text-blue-200 ml-6 mb-2">
                  Final air cleaning after all operations complete
                </p>
                
                {endOptions.carbonFilterPostPrint && (
                  <div className="ml-6 mb-3">
                    <label className="block text-white mb-1">Post-Filter Duration (seconds)</label>
                    <input
                      type="number"
                      value={endOptions.carbonFilterPostDuration}
                      onChange={(e) => updateEndOption('carbonFilterPostDuration', parseInt(e.target.value))}
                      className="w-24 px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                      min="0"
                      max="1800"
                    />
                  </div>
                )}
                
                {(endOptions.carbonFilter || endOptions.carbonFilterPostPrint || startOptions.carbonFilterDuringPrint) && (
                  <p className="text-xs text-blue-200 mt-2">Fan name must be 'carbon_filter'</p>
                )}
              </div>

              <div className="bg-white/5 p-4 rounded">
                <h3 className="text-lg font-semibold text-blue-300 mb-3">Power Down</h3>
                
                <label className="flex items-center text-white mb-2">
                  <input
                    type="checkbox"
                    checked={endOptions.resetAcceleration}
                    onChange={(e) => updateEndOption('resetAcceleration', e.target.checked)}
                    className="mr-2 w-4 h-4"
                  />
                  Reset Acceleration to Defaults
                </label>
                <p className="text-xs text-blue-200 mb-3 ml-6">
                  Prevents sensorless homing failures on next print
                </p>
                
                {endOptions.resetAcceleration && (
                  <div className="ml-6 mb-3 grid grid-cols-2 gap-2">
                    <div>
                      <label className="block text-white text-sm mb-1">Default Velocity</label>
                      <input
                        type="number"
                        value={endOptions.defaultVelocity}
                        onChange={(e) => updateEndOption('defaultVelocity', parseInt(e.target.value))}
                        className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                        min="50"
                        max="500"
                      />
                    </div>
                    <div>
                      <label className="block text-white text-sm mb-1">Default Accel</label>
                      <input
                        type="number"
                        value={endOptions.defaultAccel}
                        onChange={(e) => updateEndOption('defaultAccel', parseInt(e.target.value))}
                        className="w-full px-2 py-1 rounded bg-white/10 text-white border border-white/20"
                        min="500"
                        max="10000"
                      />
                    </div>
                  </div>
                )}
                
                <label className="flex items-center text-white mb-2">
                  <input
                    type="checkbox"
                    checked={endOptions.bedOff}
                    onChange={(e) => updateEndOption('bedOff', e.target.checked)}
                    className="mr-2 w-4 h-4"
                  />
                  Turn Off Bed Heater
                </label>
                
                <label className="flex items-center text-white mb-2">
                  <input
                    type="checkbox"
                    checked={endOptions.disableSteppers}
                    onChange={(e) => updateEndOption('disableSteppers', e.target.checked)}
                    className="mr-2 w-4 h-4"
                  />
                  Disable Steppers (M84)
                </label>
                
                <label className="flex items-center text-white">
                  <input
                    type="checkbox"
                    checked={endOptions.beep}
                    onChange={(e) => updateEndOption('beep', e.target.checked)}
                    className="mr-2 w-4 h-4"
                  />
                  Completion Beep
                </label>
              </div>
            </div>
          </div>
        </div>

        {/* Material Settings Table */}
        <div className="bg-white/10 backdrop-blur-lg rounded-lg p-6 border border-white/20 mb-6">
          <button
            onClick={() => setAdvancedOpen(!advancedOpen)}
            className="w-full flex items-center justify-between text-white mb-4"
          >
            <h2 className="text-2xl font-bold">âš™ï¸ Material-Specific Settings</h2>
            {advancedOpen ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
          </button>
          
          {advancedOpen && (
            <div className="overflow-x-auto">
              <p className="text-blue-200 mb-4">
                Configure heat soak times, chamber temps, and advanced motion settings for each material type.
                These are used when the corresponding features are enabled above.
              </p>
              
              <table className="w-full text-white text-sm">
                <thead>
                  <tr className="bg-white/10">
                    <th className="p-2 text-left">Material</th>
                    <th className="p-2 text-left">Heat Soak (min)</th>
                    <th className="p-2 text-left">Chamber (Â°C)</th>
                    <th className="p-2 text-left">Z Smooth</th>
                    <th className="p-2 text-left">Z Textured</th>
                    <th className="p-2 text-left">Pressure Adv.</th>
                    <th className="p-2 text-left">Velocity</th>
                    <th className="p-2 text-left">Accel</th>
                    <th className="p-2 text-left">SCV</th>
                  </tr>
                </thead>
                <tbody>
                  {Object.keys(materialSettings).map((material) => (
                    <tr key={material} className="border-b border-white/10">
                      <td className="p-2 font-bold text-blue-300">{material}</td>
                      <td className="p-2">
                        <input
                          type="number"
                          value={materialSettings[material].heatSoak}
                          onChange={(e) => updateMaterialSetting(material, 'heatSoak', e.target.value)}
                          className="w-16 px-1 py-1 rounded bg-white/10 text-white border border-white/20"
                          min="0"
                          max="30"
                        />
                      </td>
                      <td className="p-2">
                        <input
                          type="number"
                          value={materialSettings[material].chamberTemp}
                          onChange={(e) => updateMaterialSetting(material, 'chamberTemp', e.target.value)}
                          className="w-16 px-1 py-1 rounded bg-white/10 text-white border border-white/20"
                          min="0"
                          max="80"
                        />
                      </td>
                      <td className="p-2">
                        <input
                          type="number"
                          value={materialSettings[material].zOffsetSmooth}
                          onChange={(e) => updateMaterialSetting(material, 'zOffsetSmooth', e.target.value)}
                          className="w-20 px-1 py-1 rounded bg-white/10 text-white border border-white/20"
                          min="-0.5"
                          max="0.5"
                          step="0.01"
                        />
                      </td>
                      <td className="p-2">
                        <input
                          type="number"
                          value={materialSettings[material].zOffsetTextured}
                          onChange={(e) => updateMaterialSetting(material, 'zOffsetTextured', e.target.value)}
                          className="w-20 px-1 py-1 rounded bg-white/10 text-white border border-white/20"
                          min="-0.5"
                          max="0.5"
                          step="0.01"
                        />
                      </td>
                      <td className="p-2">
                        <input
                          type="number"
                          value={materialSettings[material].pressureAdvance}
                          onChange={(e) => updateMaterialSetting(material, 'pressureAdvance', e.target.value)}
                          className="w-20 px-1 py-1 rounded bg-white/10 text-white border border-white/20"
                          min="0"
                          max="0.2"
                          step="0.01"
                        />
                      </td>
                      <td className="p-2">
                        <input
                          type="number"
                          value={materialSettings[material].velocity}
                          onChange={(e) => updateMaterialSetting(material, 'velocity', e.target.value)}
                          className="w-20 px-1 py-1 rounded bg-white/10 text-white border border-white/20"
                          min="10"
                          max="500"
                        />
                      </td>
                      <td className="p-2">
                        <input
                          type="number"
                          value={materialSettings[material].accel}
                          onChange={(e) => updateMaterialSetting(material, 'accel', e.target.value)}
                          className="w-20 px-1 py-1 rounded bg-white/10 text-white border border-white/20"
                          min="100"
                          max="10000"
                        />
                      </td>
                      <td className="p-2">
                        <input
                          type="number"
                          value={materialSettings[material].junctionDeviation}
                          onChange={(e) => updateMaterialSetting(material, 'junctionDeviation', e.target.value)}
                          className="w-20 px-1 py-1 rounded bg-white/10 text-white border border-white/20"
                          min="0.001"
                          max="0.02"
                          step="0.001"
                        />
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              
              <div className="mt-4 p-3 bg-blue-900/30 rounded border border-blue-500/30">
                <p className="text-xs text-blue-200">
                  <strong>Z Smooth/Textured:</strong> Base Z offset for smooth PEI vs textured build plates (e.g., smooth: 0.0, textured: +0.04mm).<br/>
                  <strong>SCV:</strong> Square Corner Velocity (similar to Jerk). Lower values = smoother corners, higher values = faster printing.
                </p>
              </div>
            </div>
          )}
        </div>

        {/* Generated Macro Output */}
        <div className="bg-white/10 backdrop-blur-lg rounded-lg p-6 border border-white/20">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-2xl font-bold text-white">ðŸ“ Generated Macros</h2>
            <button
              onClick={copyToClipboard}
              className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
            >
              {copied ? <Check size={20} /> : <Copy size={20} />}
              {copied ? 'Copied!' : 'Copy to Clipboard'}
            </button>
          </div>
          
          <div className="bg-gray-900 rounded-lg p-4 overflow-x-auto">
            <pre className="text-green-400 text-sm font-mono whitespace-pre">
              {fullMacro}
            </pre>
          </div>
          
          <div className="mt-4 p-4 bg-blue-900/30 rounded-lg border border-blue-500/30">
            <h3 className="text-lg font-semibold text-blue-300 mb-3">ðŸ“‹ Setup Instructions (Follow in Order)</h3>
            
            <div className="space-y-4">
              <div className="bg-blue-800/30 p-3 rounded">
                <h4 className="font-semibold text-blue-200 mb-2">Step 1: Configure Material Settings</h4>
                <p className="text-blue-100 text-sm">
                  Open the "Material-Specific Settings" section above and adjust heat soak times, chamber temps, 
                  and motion parameters for each material type you use.
                </p>
              </div>
              
              {(endOptions.carbonFilter || endOptions.carbonFilterPostPrint) && (
                <div className="bg-blue-800/30 p-3 rounded">
                  <h4 className="font-semibold text-blue-200 mb-2">Step 2: Configure Carbon Filter in printer.cfg</h4>
                  <p className="text-blue-100 text-sm mb-2">
                    Add this to your <code className="bg-black/30 px-1 rounded">printer.cfg</code> file:
                  </p>
                  <pre className="bg-black/50 p-2 rounded text-xs text-green-300 overflow-x-auto">
{`[fan_generic carbon_filter]
pin: YOUR_PIN_HERE  # e.g., PA8
max_power: 1.0
shutdown_speed: 0
kick_start_time: 0.5`}
                  </pre>
                  <p className="text-blue-100 text-sm mt-2">
                    Replace <code className="bg-black/30 px-1 rounded">YOUR_PIN_HERE</code> with your actual fan control pin.
                  </p>
                </div>
              )}
              
              {startOptions.nozzleBrushEnabled && startOptions.nozzleBrushType === 'custom' && (
                <div className="bg-blue-800/30 p-3 rounded">
                  <h4 className="font-semibold text-blue-200 mb-2">Step {(endOptions.carbonFilter || endOptions.carbonFilterPostPrint) ? '3' : '2'}: Verify Custom Nozzle Cleaning Macro</h4>
                  <p className="text-blue-100 text-sm">
                    Ensure your custom macro <code className="bg-black/30 px-1 rounded">{startOptions.nozzleBrushMacro}</code> exists 
                    in your <code className="bg-black/30 px-1 rounded">printer.cfg</code> and is working correctly.
                  </p>
                </div>
              )}
              
              {startOptions.useClientVariables && (
                <div className="bg-blue-800/30 p-3 rounded">
                  <h4 className="font-semibold text-blue-200 mb-2">Step {
                    ((endOptions.carbonFilter || endOptions.carbonFilterPostPrint) ? 1 : 0) + 
                    ((startOptions.nozzleBrushEnabled && startOptions.nozzleBrushType === 'custom') ? 1 : 0) + 2
                  }: (Optional) Create _CLIENT_VARIABLE Macro</h4>
                  <p className="text-blue-100 text-sm mb-2">
                    To override settings without editing the macro, add this to your <code className="bg-black/30 px-1 rounded">printer.cfg</code>:
                  </p>
                  <pre className="bg-black/50 p-2 rounded text-xs text-green-300 overflow-x-auto">
{`[gcode_macro _CLIENT_VARIABLE]
variable_mesh_profile: "default"      # Override mesh name
variable_skew_profile: "my_skew"      # Override skew profile
variable_bed_warp_x: 150              # Override warp check X
variable_bed_warp_y: 150              # Override warp check Y
variable_brush_x: 50                  # Override brush X position
variable_brush_y: 300                 # Override brush Y position
variable_brush_z: 1.0                 # Override brush Z height
variable_brush_width: 50              # Override brush width
variable_brush_orientation: "X"       # Override brush orientation (X or Y)
gcode:`}
                  </pre>
                  <p className="text-blue-100 text-sm mt-2">
                    Adjust values as needed. These will override the settings configured in this tool.
                  </p>
                </div>
              )}
              
              <div className="bg-blue-800/30 p-3 rounded">
                <h4 className="font-semibold text-blue-200 mb-2">Step {
                  ((endOptions.carbonFilter || endOptions.carbonFilterPostPrint) ? 1 : 0) + 
                  ((startOptions.nozzleBrushEnabled && startOptions.nozzleBrushType === 'custom') ? 1 : 0) + 
                  (startOptions.useClientVariables ? 1 : 0) + 2
                }: Copy Generated Macros</h4>
                <p className="text-blue-100 text-sm">
                  Click "Copy to Clipboard" above and paste the generated START_PRINT and END_PRINT macros 
                  into your <code className="bg-black/30 px-1 rounded">printer.cfg</code> (or a separate macros file).
                </p>
              </div>
              
              <div className="bg-blue-800/30 p-3 rounded">
                <h4 className="font-semibold text-blue-200 mb-2">Step {
                  ((endOptions.carbonFilter || endOptions.carbonFilterPostPrint) ? 1 : 0) + 
                  ((startOptions.nozzleBrushEnabled && startOptions.nozzleBrushType === 'custom') ? 1 : 0) + 
                  (startOptions.useClientVariables ? 1 : 0) + 3
                }: Configure OrcaSlicer</h4>
                <div className="space-y-2 text-sm">
                  <div>
                    <p className="text-blue-200 font-medium">Machine Start G-code:</p>
                    <pre className="bg-black/50 p-2 rounded text-xs text-green-300 overflow-x-auto mt-1">
{startOptions.useBedTypeZOffset 
  ? `START_PRINT BED_TEMP=[bed_temperature_initial_layer_single] EXTRUDER_TEMP=[nozzle_temperature_initial_layer] FILAMENT_TYPE=[filament_type] CHAMBER_TEMP=[chamber_temperature] BED_TYPE=SMOOTH`
  : `START_PRINT BED_TEMP=[bed_temperature_initial_layer_single] EXTRUDER_TEMP=[nozzle_temperature_initial_layer] FILAMENT_TYPE=[filament_type] CHAMBER_TEMP=[chamber_temperature]`}
                    </pre>
                    {startOptions.useBedTypeZOffset && (
                      <p className="text-xs text-blue-200 mt-1">
                        Change BED_TYPE to TEXTURED when using textured build plate
                      </p>
                    )}
                  </div>
                  <div>
                    <p className="text-blue-200 font-medium">Machine End G-code:</p>
                    <pre className="bg-black/50 p-2 rounded text-xs text-green-300 overflow-x-auto mt-1">
END_PRINT
                    </pre>
                  </div>
                </div>
              </div>
              
              <div className="bg-green-900/30 p-3 rounded border border-green-500/30">
                <h4 className="font-semibold text-green-200 mb-2">âœ… You're Ready!</h4>
                <p className="text-green-100 text-sm">
                  Save your Klipper config, restart firmware, and test with a small print. The macros will 
                  automatically adjust based on the filament type selected in OrcaSlicer.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
-e 

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(KlipperMacroBuilder));
    </script>
</body>
</html>
